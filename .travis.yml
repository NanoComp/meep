language: python
dist: trusty
sudo: false

##################################################
# required linux packages and python packages 
##################################################
addons:
  apt:
    packages:
    - guile-2.0-dev
    - libgsl0-dev
    - libfftw3-dev
    - gfortran
    - libhdf5-serial-dev
    - liblapack-dev
    - swig
    - libopenmpi-dev
    - mpi-default-bin
install:
  - pip install numpy mpi4py

##################################################
# environment variables applied to all build cases 
##################################################
env:
  global:
  - CPPFLAGS=-I${HOME}/local/include LDFLAGS=-L${HOME}/local/lib GEN_CTL_IO=${HOME}/local/bin/gen-ctl-io

##################################################
# common installations performed before all build cases
##################################################
before_script:
  - git clone https://github.com/stevengj/libctl libctl-src
  - (cd libctl-src && git checkout master && sh autogen.sh --prefix=$HOME/local --enable-shared && make && make install)
  - git clone https://github.com/stevengj/harminv
  - (cd harminv && git checkout c221b2bcbaaa761f683aa5e2c6fa7efbbecdca1f && sh autogen.sh --prefix=$HOME/local --enable-shared && make && make install)

##################################################
# build matrix:
##################################################
matrix:
  - python: "2.7"
    env: MPICONF="--without-mpi"
  - python: "2.7"
    env: MPICONF="--with-mpi"
  - python: "3.4"
    env: MPICONF="--without-mpi"
  - python: "3.4"
    env: MPICONF="--with-mpi"

##################################################
# build/test instructions    
##################################################
script:
  - autoreconf --verbose --install --symlink --force
  - mkdir build && pushd build
  - (CPPFLAGS=-I${HOME}/local/include LDFLAGS=-L${HOME}/local/lib GEN_CTL_IO=${HOME}/local/bin/gen-ctl-io ../configure --enable-maintainer-mode --prefix=$HOME/local --with-libctl=$HOME/local/share/libctl --with-python ${MPICONF} && make && make check && make install)
  - popd

##################################################
##################################################
##################################################
after_script:
  - if [ -r test-suite.log ]; then cat test-suite.log; fi
  - if [ -r tests/test-suite.log ]; then cat tests/test-suite.log; fi
  - if [ -r python/test-suite.log ]; then cat python/test-suite.log; fi
