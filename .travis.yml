language: cpp
addons:
  apt:
    packages:
    - guile-2.0-dev
    - libgsl0-dev
    - libfftw3-dev
    - gfortran
    - libhdf5-serial-dev
    - liblapack-dev
    - python-numpy
    - swig
before_script:
  - wget https://repo.continuum.io/miniconda/Miniconda3-4.3.14-Linux-x86_64.sh
  - bash Miniconda3-4.3.14-Linux-x86_64.sh -b -p ${HOME}/miniconda3
  - ${HOME}/miniconda3/bin/conda install -y numpy
script:
  - git clone https://github.com/stevengj/libctl libctl-src
  - (cd libctl-src && git checkout master && sh autogen.sh --prefix=$HOME/local --enable-shared && make && make install)
  - git clone https://github.com/stevengj/harminv
  - (cd harminv && git checkout c221b2bcbaaa761f683aa5e2c6fa7efbbecdca1f && sh autogen.sh --prefix=$HOME/local --enable-shared && make && make install)
  - (CPPFLAGS=-I${HOME}/local/include LDFLAGS=-L${HOME}/local/lib GEN_CTL_IO=${HOME}/local/bin/gen-ctl-io sh autogen.sh --verbose --enable-maintainer-mode --prefix=$HOME/local --with-libctl=$HOME/local/share/libctl)
  - mkdir build && pushd build
  - (CPPFLAGS=-I${HOME}/local/include LDFLAGS=-L${HOME}/local/lib GEN_CTL_IO=${HOME}/local/bin/gen-ctl-io ../configure --enable-maintainer-mode --prefix=$HOME/local --with-libctl=$HOME/local/share/libctl)
  - make && make install
  # - make && make check && make install
  - echo "CWD" `pwd`
  - make check
  - cat tests/test_geom.log
  # Build and test pymeep with python 3.6
  - (CPPFLAGS=-I${HOME}/local/include LDFLAGS=-L${HOME}/local/lib GEN_CTL_IO=${HOME}/local/bin/gen-ctl-io PYTHON=${HOME}/miniconda3/bin/python sh autogen.sh --verbose --enable-maintainer-mode --prefix=$HOME/local --with-libctl=$HOME/local/share/libctl)
  - pushd python && make clean && make && make check && make install && popd

before_deploy:
  - make dist
deploy:
  provider: releases
  api_key:
    secure: QgfuB0UAOE7oIQxWaaiVP1ofrBIQql3CW0aX3r8FJewk1jgK7yn+owpgtUHWvdV+77q14+6GFW0ljq/RaA4O1ltttg15DhaJ2tpmnEnEzJWOR1uB2hcmiSn0WO1UF6rcwtS4XX2KOhsbRl7Yt7rNb+GoQB3yvya8CQJ2NwWt7YLdWJblbPeTYY4xm5uqHt3vXltO3vOofivc+e/dykFzNoeY6bSNemc2aCDHyZAxU70D6T1gbd/VbNF/f4gmPmnF13tfi318vRJyM1LRQs/T34GOjEnZj6jf9p1RQaYgSf7eqeNVT5THy1NQDmeMWUMCiDY9O+xQiZ3TwTKCrMLuEJtKMp9Qpv7hO/8xdveu10dzJjpQbslppxvdnT9EeA9eATTl8oAAX993yaAovQySIiUT98Rt2+ComhVB8AEsR5zmzUHFOSuPhvjC+75W4FE8t3VtMeUhEowTzlqlbfomKm3fR6MB/sA0lG8+wo2w1zSftFPAGOITLRDXbftkqQb9o2VhEeWa0x2l6aigCJ+/8+PAn3UeTT+lFH96jy9lWHKLD9+lhGlwoUp514R9zlmaCxZHRu71eaXr0nYWaw5zktAB26G2brb3km4FQ9P1nrmfykvxFaEcwQOGs6K3qE4J+KpVha6wBpBh+DycfUPDFKvnO/6SSeO35fIBEplJj+A=
  file: "meep-${TRAVIS_TAG}.tar.gz"
  skip_cleanup: true
  on:
    tags: true
